<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Medical Assistant (Groq)</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>üè• Groq Multi-Agent Medical Assistant</h1>
        <p>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –î–∏–∞–≥–Ω–æ–∑–∞, –ü–ª–∞–Ω–∞ –ª–µ—á–µ–Ω–∏—è –∏ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (FastAPI + –ß–∏—Å—Ç—ã–π Groq).</p>

        <form id="diagnosis-form">
            <div class="form-group">
                <label for="symptoms">–°–∏–º–ø—Ç–æ–º—ã (Symptoms):</label>
                <textarea id="symptoms" name="symptoms" rows="4" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∏–ª—å–Ω–∞—è –≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å, —É–º–µ—Ä–µ–Ω–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 37.8¬∞C, –±–æ–ª—å –≤ –≥–æ—Ä–ª–µ."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="age">–í–æ–∑—Ä–∞—Å—Ç (Age):</label>
                    <input type="number" id="age" name="age" required min="1" max="120" value="30">
                </div>
                <div class="form-group">
                    <label for="gender">–ü–æ–ª (Gender):</label>
                    <select id="gender" name="gender" required>
                        <option value="Male">–ú—É–∂—Å–∫–æ–π</option>
                        <option value="Female">–ñ–µ–Ω—Å–∫–∏–π</option>
                        <option value="Other">–î—Ä—É–≥–æ–π</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="history">–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) (Medical History):</label>
                <textarea id="history" name="history" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–ª–µ—Ä–≥–∏—è –Ω–∞ –ø–µ–Ω–∏—Ü–∏–ª–ª–∏–Ω, —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π –≥–∞—Å—Ç—Ä–∏—Ç."></textarea>
            </div>

            <button type="submit" class="submit-button">–ü–æ–ª—É—á–∏—Ç—å –î–∏–∞–≥–Ω–æ–∑ –∏ –õ–µ—á–µ–Ω–∏–µ</button>
        </form>

        <div id="error-area" class="error-box" style="display:none;">
            <h2>–û—à–∏–±–∫–∞:</h2>
            <p id="error-message"></p>
        </div>

        <div id="result-area" style="display:none;">
            <h2>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤</h2>

            <div class="output-section">
                <h3>–ê–≥–µ–Ω—Ç 1: –î–∏–∞–≥–Ω–æ—Å—Ç (Diagnosis)</h3>
                <div id="diagnosis-output" class="output-content"></div>
            </div>

            <div class="output-section">
                <h3>–ê–≥–µ–Ω—Ç 2: –¢–µ—Ä–∞–ø–µ–≤—Ç (Treatment Plan)</h3>
                <div id="treatment-output" class="output-content"></div>
            </div>

            <div class="output-section">
                <h3>–ê–≥–µ–Ω—Ç 3: –ú–æ–Ω–∏—Ç–æ—Ä (Monitoring Feedback)</h3>
                <div id="monitoring-output" class="output-content"></div>
            </div>

        </div>
    </div>

    <script>
        // *** –ö–ª—é—á–µ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è Markdown –≤ HTML ***
        function markdownToHtml(markdownText) {
            if (!markdownText) return '';

            let html = markdownText;

            // 1. –ó–∞–≥–æ–ª–æ–≤–∫–∏ (### H3)
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            // 2. –ó–∞–≥–æ–ª–æ–≤–∫–∏ (## H2)
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            // 3. –ó–∞–≥–æ–ª–æ–≤–∫–∏ (# H1)
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

            // 4. –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç (**text**)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // 5. –ö—É—Ä—Å–∏–≤ (*text*)
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // 6. –°–ø–∏—Å–∫–∏ (* Item –∏–ª–∏ - Item) - –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —Å–ø–∏—Å–∫–∞
            let listContent = '';
            const lines = html.split('\n');
            let inList = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                if (line.match(/^[\*\-]\s/)) {
                    if (!inList) {
                        listContent += '<ul>\n';
                        inList = true;
                    }
                    listContent += `<li>${line.replace(/^[\*\-]\s/, '').trim()}</li>\n`;
                } else {
                    if (inList) {
                        listContent += '</ul>\n';
                        inList = false;
                    }
                    listContent += lines[i] + '\n';
                }
            }
            if (inList) {
                 listContent += '</ul>\n';
            }
            html = listContent.trim();

            // 7. –†–∞–∑—Ä—ã–≤—ã —Å—Ç—Ä–æ–∫ (–∑–∞–º–µ–Ω—è–µ–º –¥–≤–æ–π–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫–∏ –Ω–∞ <br><br> –¥–ª—è –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤)
            html = html.replace(/\n\n/g, '<br><br>');

            return html;
        }

        document.getElementById('diagnosis-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –ø–æ–∫–∞–∑ –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('result-area').style.display = 'none';
            document.getElementById('error-area').style.display = 'none';
            document.getElementById('diagnosis-output').innerHTML = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            document.getElementById('treatment-output').innerHTML = '';
            document.getElementById('monitoring-output').innerHTML = '';

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/diagnose_and_treat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º .innerHTML –∏ —Ñ—É–Ω–∫—Ü–∏—é MarkdownToHtml –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    document.getElementById('diagnosis-output').innerHTML = markdownToHtml(result.diagnosis);
                    document.getElementById('treatment-output').innerHTML = markdownToHtml(result.treatment);
                    document.getElementById('monitoring-output').innerHTML = markdownToHtml(result.monitoring_feedback);

                    document.getElementById('result-area').style.display = 'block';
                } else {
                    document.getElementById('error-message').textContent = result.error;
                    document.getElementById('error-area').style.display = 'block';
                }
            } catch (error) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –∏ –ø—Ä–æ—á–∏—Ö –æ—à–∏–±–æ–∫
                document.getElementById('error-message').textContent = 'Network or parsing error: ' + error.message;
                document.getElementById('error-area').style.display = 'block';
            }
        });
    </script>
</body>
</html>